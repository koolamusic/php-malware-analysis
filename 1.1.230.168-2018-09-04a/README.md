# niladd.php: email spamming tool

[Another instance](https://malwaredecoder.com/result/ce65968db37d404e8856d8513f0c75a4),
unfortunately not dated.
I got that URL by googling for Hungarian notation variable names that appear in the deobfuscated source.

Another [attempted installation](42.104.104.245-2018-09-08a) 
and [two more](202.160.147.186-2018-09-08a) that my honey pot caught on Sept 8th 2018.
Exactly the same operation.

## Origin

### IP Address 1.1.230.168, some place in Thailand

1.1.230.168 has a reverse lookup as "node-ka0.pool-1-1.dynamic.totbb.net"

node-ka0.pool-1-1.dynamic.totbb.net has an A record of 1.1.230.168, so that works out nicely.

`whois` says this about 1.1.230.168:

    inetnum:        1.1.192.0 - 1.1.255.255
    netname:        TOTNET
    descr:          Dynamic IP Address for residential Broadband Customers
    address:        TOT Public Company Limited
    address:        89/2 Moo 3 Chaengwattana Rd, Laksi,Bangkok 10210 THAILAND
    e-mail:         apipolg@tot.co.th
    last-modified:  2017-06-21T07:19:22Z
    route:          1.1.224.0/19
    descr:          TOT Public Company Limited
    origin:         AS23969
    mnt-by:         MAINT-TH-TOT
    last-modified:  2012-03-13T04:02:03Z
    source:         APNIC

IP address 1.1.230.168 was "Windows 7 or 8" according to `p0f3`.
This does not agree with the User Agent string of `"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10; rv:33.0) Gecko/20100101 Firefox/33.0"`.
That's not too surprising.
The last probable Real Human who used that user agent string visited my
web site 2016-12-21T02:39:36-07 from 90.42.4.66.
Since then, nothing but bots and malware have that user agent string.

### Download

Downloaded a file using HTTP with parameters typical of Web Shell by oRb,
a widely-distributed web shell used as a backdoor and uploader.

|Name|Value|Note|
|----|-----|---------|
|pass|ryfgddjs1|commonly-used WSO password
|charset|Windows-1251|Default WSO character set
|a|FilesMAn|action for WSO to take
|p1|uploadFile|sub-action of "FilesMAn"

The [file uploaded](1.1.230.168W45HAAHulpcA4krt--ErqAAAAAc.0.file) would be named `niladd.php` by WSO.
The file `niladd.php` would not be immediately interpreted by WSO,
but it would be accessible by URL from another computer.

The attacker installed `niladd.php` with a single invocation of WSO.
It did not perform any login step(s), but sent along a password with
the download.
WSO instances typically allow this.
The attacker could have made things a little more obscure by sending
a cookie whose name is the MD5 hash of the HTTP server,
and value is the MD5 hash of the password, but other than that,
this is efficient.

## Deobfuscation

To get to the [original source code](dc1.php) only a Base 64 decoding was necessary.
Barely obfuscated at all.
The decoding wrapper might plausibly be randomized:
the only variable name in it is `$_89a6b19d104c81a49c19594262b5ed8f9b6b6a5a`,
which no human would write for their own consumption.

## Analysis

This may be old code, or code written by an unknowledgeable PHP programmer.

* It only examines the `$_POST` superglobal array,
it does not use `$_REQUEST`. Seems like a rookie mistake,
or a holdover from the days before PHP had `$_REQUEST`.
* It examines all of POST name/value pairs, but actually use only the last one.
* Previous versions of commented-out code left in `function Mail_InitData()`
* Composes a template in `function Mail_InitData()` by concatentating strings,
but fills in the template in function `Mail_Generate()` with `preg_replace()` calls
It would be less work to concatenate the strings with the values desired
instead of composing template placeholders, only to immediately replace the placeholders.
* Implements its own SMTP implementation,
complete with a state machine that has one function per state
and timeouts,
Hungarian-notation variables
and an overall "enterprise" software feel to it.
* Loads "socket" extension on its own, does not rely on `php.ini` to enable the socket extension.

#### Hungarian notation variable name examples

* `$g_aOpData` - global array
* `$g_iLockedOps` - global integer
* `$g_sMailBody` - global string

## Subsequent Invocation

113.161.240.99 invoked `niladd.php` shortly after 1.1.230.168 installed it.

1. installation: 2018-09-04T02:49:04.000-0600
2. invocation: 2018-09-04T02:49:39.000-0600

Elapsed time between "installation" and invocation: 34.6 seconds.

<!--
1.1.230.168 - - [04/Sep/2018:02:49:04 -0600] "POST //blog/wp-content/themes/twentytwelve/404.php HTTP/1.0" 200 13505 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10; rv:33.0) Gecko/20100101 Firefox/33.0"
113.161.240.99 - - [04/Sep/2018:02:49:39 -0600] "POST //blog/wp-content/themes/twentytwelve/niladd.php HTTP/1.0" 200 31608 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10; rv:33.0) Gecko/20100101 Firefox/33.0"

[2018/09/04 02:49:03] mod=syn|cli=1.1.230.168/62998|srv=162.246.45.144/80|subj=cli|os=Windows 7 or 8|dist=14|params=none|raw_sig=4:114+14:0:1440:8192,2:mss,nop,ws,nop,nop,sok:df,id+:0
[2018/09/04 02:49:03] mod=mtu|cli=1.1.230.168/62998|srv=162.246.45.144/80|subj=cli|link=IPIP or SIT|raw_mtu=1480
[2018/09/04 02:49:03] mod=syn+ack|cli=1.1.230.168/62998|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*20,7:mss,nop,nop,sok,nop,ws:df:0
[2018/09/04 02:49:03] mod=mtu|cli=1.1.230.168/62998|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500
[2018/09/04 02:49:37] mod=syn|cli=113.161.240.99/62871|srv=162.246.45.144/80|subj=cli|os=Windows 7 or 8|dist=13|params=none|raw_sig=4:115+13:0:1452:8192,0:mss,nop,nop,sok:df,id+:0
[2018/09/04 02:49:37] mod=mtu|cli=113.161.240.99/62871|srv=162.246.45.144/80|subj=cli|link=DSL|raw_mtu=1492
[2018/09/04 02:49:37] mod=syn+ack|cli=113.161.240.99/62871|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*20,0:mss,nop,nop,sok:df:0
[2018/09/04 02:49:37] mod=mtu|cli=113.161.240.99/62871|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500


% This query was served by the APNIC Whois Service version 1.88.15-46 (WHOIS-US3)


   Domain Name: TOTBB.NET
   Registry Domain ID: 169442440_DOMAIN_NET-VRSN
   Registrar WHOIS Server: whois.PublicDomainRegistry.com
   Registrar URL: http://www.publicdomainregistry.com
   Updated Date: 2018-06-01T06:40:41Z
   Creation Date: 2005-06-13T07:26:36Z
   Registry Expiry Date: 2019-06-13T07:26:36Z
   Registrar: PDR Ltd. d/b/a PublicDomainRegistry.com
   Registrar IANA ID: 303
   Registrar Abuse Contact Email: abuse-contact@publicdomainregistry.com
   Registrar Abuse Contact Phone: +1.2013775952
   Domain Status: ok https://icann.org/epp#ok
   Name Server: NS1.TOTBB.NET
   Name Server: NS2.TOTBB.NET
   DNSSEC: unsigned
   URL of the ICANN Whois Inaccuracy Complaint Form: https://www.icann.org/wicf/
>>> Last update of whois database: 2018-09-04T19:02:16Z <<<

For more information on Whois status codes, please visit https://icann.org/epp

NOTICE: The expiration date displayed in this record is the date the
registrar's sponsorship of the domain name registration in the registry is
currently set to expire. This date does not necessarily reflect the expiration
date of the domain name registrant's agreement with the sponsoring
registrar.  Users may consult the sponsoring registrar's Whois database to
view the registrar's reported date of expiration for this registration.

TERMS OF USE: You are not authorized to access or query our Whois
database through the use of electronic processes that are high-volume and
automated except as reasonably necessary to register domain names or
modify existing registrations; the Data in VeriSign Global Registry
Services' ("VeriSign") Whois database is provided by VeriSign for
information purposes only, and to assist persons in obtaining information
about or related to a domain name registration record. VeriSign does not
guarantee its accuracy. By submitting a Whois query, you agree to abide
by the following terms of use: You agree that you may use this Data only
for lawful purposes and that under no circumstances will you use this Data
to: (1) allow, enable, or otherwise support the transmission of mass
unsolicited, commercial advertising or solicitations via e-mail, telephone,
or facsimile; or (2) enable high volume, automated, electronic processes
that apply to VeriSign (or its computer systems). The compilation,
repackaging, dissemination or other use of this Data is expressly
prohibited without the prior written consent of VeriSign. You agree not to
use electronic processes that are automated and high-volume to access or
query the Whois database except as reasonably necessary to register
domain names or modify existing registrations. VeriSign reserves the right
to restrict your access to the Whois database in its sole discretion to ensure
operational stability.  VeriSign may restrict or terminate your access to the
Whois database for failure to abide by these terms of use. VeriSign
reserves the right to modify these terms at any time.

The Registry database contains ONLY .COM, .NET, .EDU domains and
Registrars.
Domain Name: TOTBB.NET
Registry Domain ID: 169442440_DOMAIN_NET-VRSN
Registrar WHOIS Server: whois.publicdomainregistry.com
Registrar URL: www.publicdomainregistry.com
Updated Date: 2018-08-01T03:20:18Z
Creation Date: 2005-06-13T07:26:36Z
Registrar Registration Expiration Date: 2019-06-13T07:26:36Z
Registrar: PDR Ltd. d/b/a PublicDomainRegistry.com
Registrar IANA ID: 303
Domain Status: OK https://icann.org/epp#OK
Registry Registrant ID: Not Available From Registry
Registrant Name: TOT Public Company Limited
Registrant Organization: -
Registrant Street: 89/2 Moo 3, Chaeng Watthana Road Tung Song Hong  
Registrant City: Laksi Bangkok
Registrant State/Province: 
Registrant Postal Code: 10210
Registrant Country: TH
Registrant Phone: +66.6625748505
Registrant Phone Ext: 
Registrant Fax: 
Registrant Fax Ext: 
Registrant Email: worawat@totbb.com
Registry Admin ID: Not Available From Registry
Admin Name: Worawat Songwiwat
Admin Organization: -
Admin Street: TOT Public Company Limited 89/2 Moo 3, Chaeng Watthana Road, Tung Song Hong 
Admin City: Laksi Bangkok
Admin State/Province: 
Admin Postal Code: 10210
Admin Country: TH
Admin Phone: +66.6625748505
Admin Phone Ext: 
Admin Fax: 
Admin Fax Ext: 
Admin Email: worawat@totbb.com
Registry Tech ID: Not Available From Registry
Tech Name: Worawat Songwiwat
Tech Organization: -
Tech Street: TOT Public Company Limited 89/2 Moo 3, Chaeng Watthana Road, Tung Song Hong 
Tech City: Laksi Bangkok
Tech State/Province: 
Tech Postal Code: 10210
Tech Country: TH
Tech Phone: +66.6625748505
Tech Phone Ext: 
Tech Fax: 
Tech Fax Ext: 
Tech Email: worawat@totbb.com
Name Server: ns1.totbb.net
Name Server: ns2.totbb.net
DNSSEC: Unsigned
Registrar Abuse Contact Email: abuse-contact@publicdomainregistry.com
Registrar Abuse Contact Phone: +1.2013775952
URL of the ICANN WHOIS Data Problem Reporting System: http://wdprs.internic.net/
>>> Last update of WHOIS database: 2018-09-04T19:02:35Z <<<

For more information on Whois status codes, please visit https://icann.org/epp

Registration Service Provided By: SMARTZAP CO. LTD.

The data in this whois database is provided to you for information purposes 
only, that is, to assist you in obtaining information about or related to a 
domain name registration record. We make this information available "as is",
and do not guarantee its accuracy. By submitting a whois query, you agree 
that you will use this data only for lawful purposes and that, under no 
circumstances will you use this data to: 
(1) enable high volume, automated, electronic processes that stress or load 
this whois database system providing you this information; or 
(2) allow, enable, or otherwise support the transmission of mass unsolicited, 
commercial advertising or solicitations via direct mail, electronic mail, or 
by telephone. 
The compilation, repackaging, dissemination or other use of this data is 
expressly prohibited without prior written consent from us. The Registrar of 
record is PDR Ltd. d/b/a PublicDomainRegistry.com. 
We reserve the right to modify these terms at any time. 
By submitting this query, you agree to abide by these terms.
-->

`whois` has this to say about the invoking IP address:

    inetnum:        113.160.0.0 - 113.191.255.255
    netname:        VNPT-VN
    descr:          Vietnam Posts and Telecommunications Group
    descr:          No 57, Huynh Thuc Khang Street, Lang Ha ward, Dong Da district, Ha Noi City
    country:        VN
    last-modified:  2018-01-25T03:55:17Z
    irt:            IRT-VNNIC-AP
    address:        Ha Noi, VietNam


The IP routing agrees:

    route:          113.161.224.0/19
    descr:          VietNam Post and Telecom Corporation (VNPT)
    descr:          VNPT-AS-AP
    country:        VN
    origin:         AS45899
    last-modified:  2010-08-10T08:20:09Z

So a Thai IP address installs malware,
which is invoked by a Viet Namese IP address shortly thereafter,
which ends up sending email to a Russian email account.
What an international delight!

## HTTP Parameters

I bothered to decode the subsequent invocation's
HTTP parameters:

* To address: 'mxs.mail.ru:barankunkulazaba@mail.ru'
* Subject: 'aHR0cDovL3N0cmF0aWdlcnkuY29tLy9ibG9nL3dwLWNvbnRlbnQvdGhlbWVzL3R3ZW50eXR3ZWx2ZS9uaWxhZGQucGhw'
* Body: '9/4/2018 2497996'
* From name: ''
* From address: 'LiseFox@nctrialattorneys.com'

The decoded subject is actually another layer of Base64 encoding.
Decoded, it says: `http://stratigery.com//blog/wp-content/themes/twentytwelve/niladd.php`
which would be the URL of the web-accessible `niladd.php` program.

This invocation clearly comprises an attempt to validate the installation.
If `niladd.php` got installed, and the machine and PHP interpreter
work, then "barankunkulazaba@mail.ru" would get an email
he, she, it or them could match with the installation.

I googled "barankunkulazaba@mail.ru" and found [this spam report](http://www.aprendiver.com/spamreports/spamreport.07Jun2017-16_06_22)
from 2017. I'm not at all sure what the "mxs.mail.ru:" prefix does.
My guess is that it invalidates the email.
Given that the "from name" parameter was empty, this may constitute
a coding mistake.

I didn't find any google references to "LiseFox@nctrialattorneys.com",
but `nctrialattorneys.com` has an IP address of 50.63.202.17,
a GoDaddy hosting IP address. `nctrialattorneys.com` is also
registered via GoDaddy. I assume this use is just an artifact.
