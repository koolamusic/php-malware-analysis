
# PHP Malware Analysis

Rough cut analysis of PHP source code that I got via
running a [WordPress honey pot](http://stratigery.com/phparasites)

This illustrates what I think the bottom feeders who hack WordPress sites do,
once they have illegitimate access to a new WordPress instance or host.
It's not scientific in any way. I'm only decoding the pieces of malware
that arrive at one honey pot, and I'm only decoding those pieces that
seem interesting because of method of download, obfuscation or unique
content. Oddities are over-represented because of that.

----

## Broad malware categories

This collection of PHP malware, all found in the wild,
fits into a number of categories:

* Email spamming tools
* Access verification
* Reconnaisance, which has subcategories
* Web shells
* Backdoors
* SOCKS servers
* HTTP redirectors
* File Managers
* Password guessers

Some combinations occur: web shells, particularly WSO, often get used
as a backdoor (Php action, RC action). Access verification is a
form of reconnaisance.

Recon sometimes just looks at what CMS/frameworks are present,
but other times collects information about user ID, type and version
of OS, file system hints, useful only for potential lateral moves.
[GetDomains recon](GetDomains) seems like something of both, though.

----

## Broad meta-malware categories

It seems to me that there are "cross cutting" aspects
of this kind of collection and analysis.

* Password guessing campaigns
* Methods of download, commonality with other malware
* Common "dropper" code usage
* Common phone-home code
* Common back-connect shell code (usually Perl)
* Methods of encoding/encryption (e.g. FOPO)
* Geolocation of attacking IP
* Campaign(s) associated with a specific malware
* subsequent access(es) of downloaded code
* previous access(es) of downloaded code
* common password lists used for guessing

----

## [Vigilante Malware Cleaner](198.71.239.41-2018-05-19a)

Code that tries to identify 56 fragments of PHP that
indicate files containing them are probably malware,
including itself.
Renames suspect files, which probably renders them inoperative.
This seems like a very unique effort.

## [Python password guesser](120.229.163.49-2018-10-28a)

A PHP manager that downloads, runs, then deletes, a Python
program that downloads a list of domain names,
enumerates users of WordPress blogs on those domain names,
and tries to guess working passwords.
Guesses passwords using `xmlrpc.php` calls, not through
the WordPress login page.

## [Thoroughly kinked WSO 2.1 web shell](wew.php)

The most backdoored download I've ever seen. A WSO 2.1 web shell, with
two phone-homes It also downloads the LeafMail mailing tool, and a WSO 2.6
web shell.

## [Crouching JPEG, Hidden PHP - web shell](b374k_3.2.3.php)

An instance of b374k Web Shell, which gets some code from EXIF
data of a googleusercontent.com JPEG image.

## [WSO 4.1.1 Encrypted Malware](NxAcGg)

A batch of malware received between 2017-11-23 and 2018-05-03
sharing a common method of encryption.
The encryption appears to be from WSO 4.x series of web shells,
but it has a much shorter key (8 vs 44 bytes).
At least 52 different downloads, including 4 instances of [mumblehard](chat.pl)
It's refreshing to see someone using non-trivial encryption.

## [CGI-Telnet web shell](cgi-telnet)

b374k has a link to download this moderately capable
web shell from pastebin.

## [Mumblehard deep dive](chat.pl)

Mumblehard botnet: a server that relays TCP/IP connections,
and a persistent payload, executed by cron, that can
download code from a command and control server, then
start it running.

## [Mumblehard campaign](mumblehard)

Examination of the 44 Mumblehard instances I caught,
to see how the code and methods progress as time goes by.

## [Extendable back door](cscript)

A password-protected, plugin-extendable back door.

## [Kinked theme and webroot](activex)

A fake-ish theme, complete with a WSO web shell that
phones home, and an earlier version of `webroot.php`.

## [Kinked theme simppeli](107.175.218.241-2018-10-14a)

Another compromised WordPress theme, containing a seemingly
random complement of malware.

## [Backdoor using RC4 encryption](1.php)

A moderately capable backdoor: saves and executes files,
as well as immediate PHP eval.
Uses native PHP [RC4](https://en.wikipedia.org/wiki/RC4)
encryption for password and data transfered.

## [.htaccess redirector with un-vigilante](98.172.253.136-2018-08-03a)

Creates a `.htaccess` file that redirects users to yourstockexpert.su,
googlebot, bingbot and Baiduspider get a 404.

Undoes any file name changes that an invocation of the Vigilante Malware Cleaner
might make, too. That just seems weird, since ".suspected" file name
complaints are around, but not overwhelming. Maybe inter-spamgang warfare?

## [Jijle3, WSO 2.5 variant web shell](154.121.7.26-2018-08-07a)

A WSO 2.5 web shell heavily modified by adding code from various
other hacking tools.

## [WSO 2.5 installation](campaignA)

3.993 second WSO (Web Shell by oRb, a.k.a. "FilesMan")
installation, only eight HTTP requests, including a cold WordPress login.

## [Link Injector](202.178.125.156-2018-09-10a)

Apparently an attempt to direct Chinese web traffic to a Macau casino
by means of link spamming.
Aren't search engines too sophisticated for this to work?

## [Edit ASP, PHP, JSP, ASPX files](119.103.188.94-2018-10-30a)

Modifies all .asp, .aspx, .php and .jsp file that have an
assignment to a variable name `remote_server` to assign "www.guanjianfalan.com"
to that variable.

## [Two Plugin Zip files - web shell](customizer-ui-experimenks.php)

Uploads of two Zip-format-files, one of which is WSO 2.5 with some
camoflaging code. The other Zip file has an ELF-format executable
and a small piece of PHP to run that executable in the background.

## [nptzow and nowir - SEO tool](nptzow)

Seems to be some kind of search engine optimization thing.
It serves up different results for "human" or "bot" invokers.
When it decides you're a "bot" it asks a server for text to fill out template HTML. 
Failing that, it gets text from ask.com or yahoo.com

## [SEO tool related to nptzow](45.227.252.251-2018-08-19a)

Dropper that leaves a PHP file behind, which in turn
injects PHP code into every theme's `header.php` file.
If the theme injection determines that an access is from a "bot"
(basically every search engine that ever was, plus lots of
crawler libraries), it gets HTML from zalroews.pw to pass
back to the "bot".

## [Backdoor installation campaign](campaignE)

A 12-access campaign to install a backdoor.
Accesses from 12 different IP addresses within 20
seconds, attempting to download one of 2, individually-obfuscated
backdoors.

## [phpd.local - Native PHP SOCKS server](phpd.local)

Native PHP SOCKS server. I often see Perl and even compiled ("bouncer")
SOCKS servers downloaded. Can you sell SOCKS servers on some underground
markets? Is there value in having a cut-out like this?

## [Simple SOCKS server installation campaign](campaignX)

A short (11 second, 17 HTTP request) campaign that wanted to
install Perl Simple SOCKS Server code, but failed, probably
because my WSO emulation is not accurate enough.

## [Email spamming tool](1.1.230.168-2018-09-04a)

Three attempts to install an email spamming tool,
featuring attempts to invoke the tool 34 seconds later.

## [wp-newsletter](wp-newsletter)

Two versions of something.

## [claw.php - web shell](claw.php)

c99 web shell inside 10-12 levels of obfuscation.

## [IndoXploit - web shell](IndoXploit)

Simple web shell, credits itself to an Indonesian URL.

## [Simple web shell/backdoor](118.184.47.13-2018-10-30a)

A simple backdoor, with just enough features to allow
a human to use it without too much automation.
Use could easily be automated. May be kinked, in that
it has a backdoor itself, if you know the magic HTTP parameter.

## [promos.php - Email spamming tool](promos.php)

Email spamming tool, explodes a single POST request into multiple emails.
Has "check" function that looks up compromised machine's IP address
in various email black lists.

## [htaccess.php - web shell](WSO-htaccess.php)

WSO "Web Shell by oRb", downloaded by a previously-installed
instance of WSO.

## [db-config.php - Email spamming tool](db-config.php)

An email spamming tool, with WSO web shell appended. Complete with
"phone home" code to notify a Ukrainian web site that someone invoked the program.

## [CMS Recon tool](109.74.0.104-2017-11-28a)

Knows how to recognize 24 different CMS systems and frameworks.
Responds to an HTTP POST with a serialized summary of what CMS and framework(s) it found.

## [kaylin web shell](kaylin)

Full-featured, Chinese language web shell, with a modern webapp look to it.

## [mobile phone browser redirector](91.223.167.117-2017-12-27a)

Redirects mobile phone browsers to some other URL via
`mod_rewrite` comands in document root `.htaccess` file.

## [Access verification](31.184.234.60-2017-12-28a)

Downloads PHP code that when executed, creates an HTML file.
The downloading IP address immediately attempted to access
the HTML file, so this is probably just access verification.

## [GetDomains - reconnaisance](GetDomains)

I hypothesize this is an Apache virtual host directory
reconnaisance tool. Looks for directory names with 150+
domain name appearing suffixes, seems to emphasize Russian and eastern European
country codes.

## [archive.php - web shell](archive.php)

Modified PhpSpy web shell, disguised as a GIF file, downloaded as
a theme update. Modifications are at least to change some labels
to Turkish, and add "phone home" code that lets someone in Turkey
know that the web shell has executed. Is there no honor among thieves!?!

## [SuperFetchExec - file gateway](syslib.php)

Ancient SuperFetchExec PHP malware, still using the same old
XOR string it was using in 2012.

## [Deeply obfuscated WSO web shell](general.php)

Somewhat modified Web Shell by oRb, derived from version 2.5,
or possibly 2.9. Many levels of obfuscation.

## [Legitimate File Manager Plugin](185.220.101.21-2018-01-01a)

A real (albeit possibly off-license) file manager plugin, illegitimately
installed. Interesting dual use of COTS technology.

## [Flexible email spamming tool](ricches.php)

Email spamming tool, where all email/SOCKS/spam parameters
are transmitted in an HTTP cookie.

## [Plausibly Deniable Blind SQL Injection](188.120.231.151-2018-01-07a)

An intermediary, coded and obfuscated for my specific honey pot,
that acts as a cut-out between the downloader, and another
web site. Performs SQL injection testing on that other web site.

## [Busted Dropper - web shell](calculation.php)

Dropper that relies on a WSO 2.9 variant to execute,
except its Base64 encoding is messed up. Drops a PHP
program that can (a) delete all `.htaccess` files up to
document root, or (b) generate some underhanded JavaScript
that redirects you to a scammy website.

## [Code-in-cookie back door](212.54.205.145-2018-01-25a)

Small piece of obscured PHP that executes functions
named in HTTP cookies on PHP code also named in HTTP cookies.
Even more obfuscated than it sounds.

## [Trojaned theme - web shell](95.10.253.55-2018-01-25a)

A WordPress theme containing two PhpSpy web shells, and a
web-based file manager that phones home.

## [php.backdoor.vpsp.001](php.backdoor.vpsp.001)

An encrypting back door.

## [apikey.php - file gateway](apikey.php)

Access validation/PHP execution and file downloader.

## [LeafMailer - email spamming tool](leafmailer)

A "COTS" email spamming tool. I'm not sure what LeafMail's
business model is, however. Doesn't seem to be a way to pay
for it.

## [Blacktools PHP Mailer - email spamming tool](5.155.21.37-2018-10-19a)

Rebranded version of [LeafMailer](leafmailer).

## [monero.php - backdoor](monero.php)

Simple, HTTP POST backdoor, with a suspicious file name.

## [404.php theme file backdoor](118.184.47.13-2018-11-22a)

Confusing PHP that might execute code sent to it two times.

## [Backdoor hidden in Akismet plugin update](91.200.12.9-2018-03-04a)

A somewhate obfuscated backdoor that seems to use `assert()`
to evaluate code passed in an HTTP POST request.  Akismet plugin
update extremely broken, uses an old version, but also got commented out.

## [OS, version and user ID recon](175.155.252.85-2018-03-07a)

Composes and returns a machine-parseable string with information about
web server's file system, user ID running PHP or the web server, and
"uname" output. Nothing about the web server, which makes sense as
this recon code was downloaded to what was believed to be a pre-existing
backdoor.

## [WSO web shell with novel obfuscation](5.149.250.194-2018-03-14a)

WSO 2.5 web shell, with a novel, 2-step obfuscation.
Attacker also added some anti-search-discovery code.
Most amusing.

## [Common Decoder #1 - fUUPd](fUUPd)

PHP file downloaded via WSO that decodes and
evals some encoded PHP. Some obfuscation of
both encoded PHP payload and the decoding PHP.

## [Email spam sent through WSO Web Shell](5.188.10.27-2018-03-31a)

Email spam, the download probably works in
3 different web shells or backdoors.
Seems to be part of a spamming campaign,
my honey pot has caught additional, slightly different, emails.

## [Rebels Mailer spamming tool](176.234.34.233-2018-04-13a)

An instance of the "Rebels Mailer" web front end email spamming tool,
immediate PHP evaluator, and local file inclusion backdoor.

## [Email Cut-out](sockets.php)

Small PHP program that can use POST parameter values
to send email from the compromised machine,
concealing the email's true origin.

## [TeaM HacKer EgypT File Manager](41.35.160.37-2018-04-17a)

An actual lightweight, fast file manager, Licensed under GNU GPL v2.

## [Small Turkish Language File Manager](188.166.6.154-2018-06-10a)

Smallish, 297-line-of-code file manager, in Turkish.

## [Spam Blocklist Recon](36.65.41.151-2018-05-04a)

PHP downloaded to WSO web shell. When invoked with proper GET
parameter(s) it can check if the hostname it's on is in
Google's safe browsing as unsafe, or in Spamhaus' block list.

## [Email access verification](105.71.0.37-2018-05-17a)

Interactive web page that sends a test email to the invoker's choice of addresses.
